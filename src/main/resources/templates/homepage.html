<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
	<head>
		<meta charset="UTF-8">
		<title>HomePage</title>
		<!-- 引入项目图标 -->
		<link th:href="@{/icon/mydrive.png}" rel="icon">
		<!-- 引入layui -->
		<link th:href="@{/layui/css/layui.css}" rel="stylesheet">
		<!-- 引入bootstrap5 CSS样式-->
		<link th:href="@{/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
		<!-- 引入bootstrap5 js文件 -->
		<script src="/bootstrap/js/bootstrap.bundle.js"></script>
	</head>
	<body>
		<!-- 引入header -->
		<div th:insert="~{common :: myDriveHeaderBootstrap}"></div>
		<!-- 用于调试, 显示当前用户信息 -->
<!--		<div th:insert="~{common :: currentUserInfo}"></div>-->

		<!-- 显示用户所有文件夹 -->
		<div class="container-fluid round-1">
			<div class="d-flex justify-content-lg-start align-items-center mb-2">
				<p class="p-1 mb-0">文件夹</p>

				<!-- 按钮触发模态框 -->
				<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createFolderModal">
					新增文件夹
				</button>
			</div>

			<ul th:each="folder : ${foldersList}" class="list-group rounded-1">
				<li class="list-group-item rounded-1 d-flex justify-content-between align-items-center">
					<a th:href="@{/user/homepage/{folderId}(folderId=${folder.getFolderId()})}" class="d-flex justify-content-between align-items-center text-dark text-decoration-none">
						<div class="d-flex align-items-center">
							<img th:src="@{/icon/icons8-folder.svg}" alt="folder" class="img-fluid mr-2">
							<span th:text="${folder.getFolderName()}">Folder Name</span>
						</div>
					</a>
					<div class="dropdown">
						<button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							操作
						</button>
						<div class="dropdown-menu">
							<!-- TODO 实现文件夹删除功能 -->
							<a th:href="@{/user/deleteFolder/{folderId} (folderId=${folder.getFolderId()})}" class="dropdown-item">删除</a>
							<a href="#" th:data-folder-id="${folder.getFolderId()}" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#renameModal" onclick="setItemIdForRename(this.getAttribute('data-folder-id'), 'folder')">重命名</a>
							<a href="#" th:data-folder-id="${folder.getFolderId()}" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#moveModal" onclick="prepareMoveModal(this.getAttribute('data-folder-id'), 'folder')">移动</a>
						</div>
					</div>
				</li>
			</ul>

		</div>

		<!-- 模态框 -->
		<div class="container-fluid modal fade" id="createFolderModal" tabindex="-1" role="dialog" aria-labelledby="modelTitleId" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">创建新文件夹</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<input type="text" class="form-control" id="folderNameInput" placeholder="输入文件夹名称">
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
						<button type="button" class="btn btn-primary" onclick="createFolder()">创建</button>
					</div>
				</div>
			</div>
		</div>

		<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
		<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
		<!-- 处理创建文件夹js函数,和模态对话框 -->
		<script>
			function createFolder() {
				console.log('进入创建文件夹函数')
				var folderName = document.getElementById('folderNameInput').value.trim();
				if (folderName) {
					// 构建FormData对象
					var formData = new FormData();

					// 获得当前目录的folderId
					var parentFolderId = getCurrentFolderIdFromUrl();

					// 添加新建文件夹的名字
					formData.append('folderName', folderName);
					// 添加父文件夹id
					if (parentFolderId !== null) {
						formData.append('parentFolderId', parentFolderId);
					}

					// 发送AJAX请求到后端
					fetch('/user/createFolder', {
						method: 'POST',
						body: formData  // 使用FormData发送数据
					})
						.then(response => {
							if (response.ok) {
								return response.text();
							} else {
								return response.text().then(text => {
									throw new Error(text);
								})
							}
							//throw new Error('请求失败');
						})
						.then(data => {
							alert("文件夹创建成功");
							$('#createFolderModal').modal('hide'); // 关闭模态框
							window.location.reload(); //请求成功后刷新页面
						})
						.catch(error => {
							alert("文件夹创建失败: " + error.message);
						});
				} else {
					alert("文件夹名称不能为空！");
				}
			}

			// 获得当前所在目录的folderId, 根目录folderId为null
			function getCurrentFolderIdFromUrl() {
				var pathArray = window.location.pathname.split('/');
				var lastSegment = pathArray.pop()
				if (lastSegment === 'homepage') {
					return null;
				}
				return lastSegment;
			}
		</script>

		<!-- 显示当前用户的所有文件 -->
		<div class="container-fluid mt-4 round-1">
			<p class="p-1 ">文件</p>
			<ul th:each="file : ${filesList}" class="list-group rounded-1">
				<li class="list-group-item rounded-1">
					<div class="d-flex justify-content-between align-items-center">
						<div class="d-flex align-items-center">
							<img th:src="@{/icon/filetype-txt.svg}" alt="file" class="img-fluid mr-1">
							<span>[[${file.getFileName()}]]</span>
						</div>
						<div class="d-flex align-items-center justify-content-end">
							<div class="me-2">
								<span th:if="${file.getFileSize() < 1024}">1 KB</span>
								<span th:if="${file.getFileSize() >= 1024 and file.getFileSize() < 1024.0 * 1024.0 }">[[${#numbers.formatDecimal(file.getFileSize() / 1024.0, 1, 2)}]] KB</span>
								<span th:if="${file.getFileSize() >= 1024 * 1024 and file.getFileSize() < 1024.0 * 1024.0 * 1024.0}">[[${#numbers.formatDecimal(file.getFileSize() / (1024.0 * 1024.0), 1, 2)}]]MB</span>
								<span th:if="${file.getFileSize() >= 1024 * 1024 * 1024}">[[${#numbers.formatDecimal(file.getFileSize() / (1024.0 * 1024.0 * 1024.0), 1, 2)}]] GB</span>
							</div>
							<div class="dropdown">
								<button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
									操作
								</button>
								<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
									<a th:href="@{/user/download/{fileId} (fileId=${file.getFileId()})}" class="dropdown-item">下载</a>
									<a th:href="@{/user/deleteFile/{fileId} (fileId=${file.getFileId()})}" class="dropdown-item">删除</a>
									<a href="#" th:data-file-id="${file.getFileId()}" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#renameModal" onclick="setItemIdForRename(this.getAttribute('data-file-id'), 'file')">重命名</a>
									<a href="#" th:data-file-id="${file.getFileId()}" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#moveModal" onclick="prepareMoveModal(this.getAttribute('data-file-id'), 'file')">移动</a>
								</div>
							</div>
						</div>
					</div>
				</li>
			</ul>
		</div>

		<!-- 模态框 进行文件重命名 -->
		<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="renameModalLabel">重命名</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="renameForm">
							<div class="mb-3">
								<label for="newItemName" class="col-form-label">新的名字:</label>
								<input type="text" class="form-control" id="newItemName">
								<input type="hidden" id="itemIdForRename" value="">
								<input type="hidden" id="itemType" value="">
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
						<button type="button" class="btn btn-primary" id="submitRename">保存更改</button>
					</div>
				</div>
			</div>
		</div>

		<!-- 重命名文件或文件夹 js -->
		<script>
			let itemType = null; // 'file' 或 'folder'
			// 设置当前要重命名的文件ID
			function setItemIdForRename(itemId, type) {
				document.getElementById('itemIdForRename').value = itemId;
				itemType = type;
			}

			// 监听保存更改按钮的点击事件
			document.getElementById('submitRename').addEventListener('click', function() {
				const itemId = document.getElementById('itemIdForRename').value;
				const newItemName = document.getElementById('newItemName').value;

				const formData = new FormData();

				formData.append('itemId', itemId);
				formData.append('newItemName', newItemName);
				formData.append('itemType', itemType);

				// 发送请求到服务器以更新文件名
				fetch(`/user/renameItem/`, {
					method: 'POST',
					body: formData
				})
					.then(response => {
						if (response.ok) {
							return response.text();
						} else {
							return response.text().then(text => {
								throw new Error(text);
							})
						}
					})
					.then(data => {
						console.log('重命名文件Success:', data);
						// 关闭模态框
						var renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
						renameModal.hide();

						renameModal.hide();
						window.location.reload();
					})
					.catch((error) => {
						console.error('Error:', error);
					});
			});
		</script>

		<!-- 模态框 进行移动项目 -->
		<div class="modal fade" id="moveModal" tabindex="-1" aria-labelledby="moveModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="moveModalLabel">移动项目</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<ul id="folderTree" class="list-unstyled">
							<!-- 文件夹树在这里动态生成 -->
						</ul>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
						<button type="button" class="btn btn-primary" onclick="moveItem()">移动</button>
					</div>
				</div>
			</div>
		</div>

		<!-- 移动项目 js -->
		<script>
			let selectedFolderId = null; // 用户选择的目标文件夹ID
			let currentItemId = null; // 当前想要移动的项目（文件或文件夹）的ID
			let currentItemType = null; // 'file' 或 'folder'
			let folders = []; // 文件夹数据初始化为空数组

			// 获得所有文件夹
			async function fetchFolders() {
				try {
					const response = await fetch('/user/getAllFolders');
					if (!response.ok) {
						throw new Error('fetch all folders fail.');
					}
					return await response.json(); // 直接返回解析后的JSON数据
				} catch (error) {
					console.error('Fetching folders failed: ', error);
				}
			}

			// 显示文件夹树
			function displayFolders(folders, parentFolderId = null, containerId = 'folderTree') {
				let container = document.getElementById(containerId);
				container.innerHTML = ''; // 清空现有内容

				// 添加一个表示根目录的选项
				let rootLi = document.createElement('li');
				rootLi.className = "list-group-item list-group-item-action";
				let rootA = document.createElement('a');
				rootA.href = "#";
				rootA.textContent = "根目录";
				rootA.onclick = () => {
					selectedFolderId = null; // 表示根目录
					displayFolders(folders, null, containerId); // 可以选择刷新列表或关闭模态框等
					console.log('根目录被点击');
				};
				rootLi.appendChild(rootA);
				container.appendChild(rootLi);

				let filteredFolders = folders.filter(folder => folder.parentFolderId === parentFolderId);
				filteredFolders.forEach(folder => {
					let li = document.createElement('li');
					li.className = "list-group-item list-group-item-action";
					let a = document.createElement('a');

					a.href = "#";
					a.textContent = folder.folderName;
					a.onclick = () => {
						selectedFolderId = folder.folderId;
						displayFolders(folders, folder.folderId, containerId);
					} // 点击进入子文件夹
					li.appendChild(a);
					container.appendChild(li);
				});

			}

			// 准备移动操作
			async function prepareMoveModal(itemId, itemType) {
				currentItemId = itemId;
				currentItemType = itemType;
				if (folders.length === 0) { // 检查folders数据是否已加载
					folders = await fetchFolders() || []; // 加载数据，如果失败则fallback为一个空数组
				}
				displayFolders(folders); // 使用加载后的数据显示文件夹
			}

			// 执行移动操作
			function moveItem() {
				if (selectedFolderId !== null || selectedFolderId === null) {
					console.log(`将 ${currentItemType} ${currentItemId} 移动到文件夹 ${selectedFolderId}`);

					// 准备请求的数据
					const formData = new FormData();
					formData.append('itemId', currentItemId);
					formData.append('itemType', currentItemType);
					if (selectedFolderId !== null) {
						formData.append('targetFolderId', selectedFolderId);
					}

					// 发送AJAX请求到服务器以执行移动操作
					fetch('/user/moveItem', {
						method: 'POST',
						body: formData
					}).then(response => {
						if (response.ok) {
							return response.text();  // 或者 response.json() 如果后端返回的是JSON
						} else {
							throw new Error('Failed to move item.');
						}
					}).then(data => {
						console.log(data); // 处理成功的响应
						alert('移动成功！');
						// 关闭模态框、显示消息等操作
						var moveModal = new bootstrap.Modal(document.getElementById('moveModal'));
						moveModal.hide();
					}).catch(error => {
						console.error('Error moving item:', error);
						alert('移动失败！');
					});
				} else {
					alert("请选择一个目标文件夹");
				}
			}
		</script>

		<!-- 进行文件上传 -->
		<div class="container-fluid my-4">
			<form id="fileUploadDiv" action="/user/uploadFile" method="post" enctype="multipart/form-data"
				  class="upload-form">
				<div class="mb-3">
					<label for="fileInput" class="form-label">请选择文件</label>
					<input type="file" class="form-control bg-secondary-subtle" id="fileInput" name="file">
				</div>
				<!-- 进度条 -->
				<div class="progress my-3" style="height: 20px;">
					<div id="progressBar" class="progress-bar bg-success-subtle" role="progressbar"
						 style="width: 0%;"></div>
				</div>
				<!-- 进度信息 -->
				<div id="progressText" class="progress-text mb-3"></div>
			</form>
			<button id="uploadButton" class="btn btn-danger">上传文件</button>
			<!-- hash值计算状态 -->
			<div id="hashStatus" class="hash-status mt-3"></div>
		</div>

		<!-- 处理文件上传逻辑 -->
		<script th:inline="javascript">
			let selectedFile; // 用于存储选中的文件

			// 获得当前父目录的id
			var parentFolderId = getCurrentFolderIdFromUrl()

			// 监听文件选择变化
			document.getElementById('fileInput').addEventListener('change', (event) => {
				selectedFile = event.target.files[0]; // 保存选中的文件
			});

			document.getElementById('uploadButton').addEventListener('click', async () => {
				if (selectedFile) {
					showHashCalculationStatus('正在计算文件哈希,请稍候...');
					const fileHash = await calculateHash(selectedFile);
					showHashCalculationStatus(selectedFile.name + ' 文件哈希计算完成:' + fileHash);

					// 设置分片大小位10MB
					const chunkSize = 10 * 1024 * 1024;
					const totalChunks = Math.ceil(selectedFile.size / chunkSize);
					let uploadSuccess = true; // 追踪文件上传是否成功

					// 进行文件初始化设置
					const fileId = await initializeFileUpload(selectedFile.name, fileHash, totalChunks, parentFolderId);
					console.log('文件id是' + fileId);

					for (let i = 0; i < totalChunks; i++) {
						const chunk = selectedFile.slice(i * chunkSize, (i + 1) * chunkSize);
						const chunkHash = await calculateHash(chunk)
						console.log(`Chunk ${i}: Hash: ${chunkHash}`);

						// 检查分片是否需要上传,如果服务端存储该分片则不用上传
						const chunkExist = await checkChunkExist(chunkHash, fileId, i);
						if (chunkExist) {
							console.log(`Chunk ${i} already exists, skipping upload.`);
							updateProgress(i + 1, totalChunks);
							continue;
						}

						const formData = new FormData();

						formData.append('chunk', chunk);
						formData.append('fileId', fileId);
						formData.append('parentFolderId', parentFolderId);
						formData.append('chunkIndex', i);
						formData.append('chunkHash', chunkHash);
						formData.append('totalChunks', totalChunks);

						try {
							const response = await fetch('/user/uploadChunk', {
								method: 'POST',
								body: formData
							});
							// if (!response.ok) {
							// 	throw new Error('Upload chunk' + i + ' fail');
							// }
							//更新进度条
							updateProgress(i + 1, totalChunks);
						} catch (error) {
							console.error(error);
							alert(`上传失败: ${error.message}`);
							uploadSuccess = false;
							break;
						}
					}
					if (uploadSuccess) {
						// 更新文件大小
						const fileSize = updateFileSize(fileId);
						console.log('文件大小是: ' + fileSize);
						// 如果所有分片都成功上传，则刷新页面
						window.location.reload();
					}

				} else {
					alert("请先选择一个文件! ");
				}
			})

			// 文件上传初始化操作
			async function initializeFileUpload(fileName, fileHash, totalChunks, parentFolderId) {
				const formData = new FormData();
				formData.append('fileName', fileName);
				formData.append('fileHash', fileHash);
				formData.append('totalChunks', totalChunks);
				if (parentFolderId != null) {
					formData.append('parentFolderId', parentFolderId);
				}
				try {
					const response = await fetch('/user/initializeFileUpload', {
						method: 'POST',
						body: formData
					});

					if (!response.ok) {
						throw new Error('Failed to initialize file upload' + await response.text());
					}

					// 获得response的内容
					const fileId = await response.text();
					console.log('initialize function fileId: ' + fileId);
					return parseInt(fileId, 10);
				} catch (error) {
					console.log('Initialization error: ', error);
					alert('文件初始化操作失败');
				}
			}

			// 判断服务器端是否已经存储了该分片
			async function checkChunkExist(chunkHash, fileId, chunkIndex) {
				const formData = new FormData();
				formData.append('chunkHash', chunkHash);
				formData.append('fileId', fileId);
				formData.append('chunkIndex', chunkIndex);

				// 发送POST请求给服务端
				const response = await fetch('/user/checkChunkExist', {
					method: 'POST',
					body: formData
				})
				const result = await response.text();
				console.log('checkChunkExist function: current chunkHash' + chunkHash + ' fileId' + fileId + ' index' + chunkIndex);
				return result.toLowerCase() === 'true';
			}

			// 计算hash
			async function calculateHash(file) {
				// 读取文件内容
				const arrayBuffer = await file.arrayBuffer();

				// 计算哈希值
				const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);

				// 将ArrayBuffer转换为十六进制字符串
				const hashArray = Array.from(new Uint8Array(hashBuffer));
				const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

				return hashHex;
			}

			// 文件所有分片上传完成后调用该函数,更新文件的大小
			async function updateFileSize(fileId) {
				const formData = new FormData();

				formData.append('fileId', fileId);
				console.log('进入更新文件大小函数');

				const response = await fetch('/user/updateFileSize', {
					method: 'POST',
					body: formData
				});
				console.log('文件大小是: ' + await response.text());
				return response.text()
			}

			// 更新进度条
			function updateProgress(currentChunk, totalChunks) {
				const progressPercentage = (currentChunk / totalChunks) * 100;
				document.getElementById('progressBar').style.width = `${progressPercentage}%`;
				document.getElementById('progressText').innerText = `上传进度: ${progressPercentage.toFixed(2)}%`;
			}

			function showHashCalculationStatus(message) {
				const hashStatusElement = document.getElementById('hashStatus');
				if (hashStatusElement) {
					hashStatusElement.innerText = message;
				}
			}

			// 获得当前url的最后一个路径段
			function getLastPathSegment() {
				var pathArray = window.location.pathname.split('/');
				var lastSegment = pathArray.pop();
				return lastSegment;
			}

			// 获得当前所在目录的folderId, 根目录folderId为null
			function getCurrentFolderIdFromUrl() {
				var pathArray = window.location.pathname.split('/');
				var lastSegment = pathArray.pop()
				if (lastSegment === 'homepage') {
					return null;
				}
				return lastSegment;
			}
		</script>


		<div th:if="${uploadMessage}">
			[[${uploadMessage}]]
		</div>
	</body>
</html>